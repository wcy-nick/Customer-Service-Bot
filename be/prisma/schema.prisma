generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // Enable the postgresqlExtensions. Currently in preview
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector", schema: "extensions")] // Add the pgvector extension
}

model User {
  id                String               @id @default(uuid()) @map("id")
  createdAt         DateTime             @default(now()) @map("created_at")
  username          String               @unique @map("username")
  email             String               @unique @map("email")
  passwordHash      String               @map("password_hash")
  displayName       String?              @map("display_name")
  avatarUrl         String?              @map("avatar_url")
  isActive          Boolean              @default(true) @map("is_active")
  lastLoginAt       DateTime?            @map("last_login_at")
  updatedAt         DateTime             @default(now()) @map("updated_at")
  role              String               @default("user")
  createdCategories BusinessCategory[]
  chatSessions      ChatSession[]
  documentVersions  DocumentVersion[]
  createdDocuments  KnowledgeDocument[]  @relation("CreatedBy")
  updatedDocuments  KnowledgeDocument[]  @relation("UpdatedBy")
  createdScenarios  ScenarioCategory[]
  resolvedQuestions UnansweredQuestion[]
  sessions          UserSession[]

  @@map("users")
}

model UserSession {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("user_sessions")
}

model BusinessCategory {
  id          String              @id @default(uuid())
  name        String
  description String?
  icon        String?
  sortOrder   Int                 @default(0) @map("sort_order")
  isActive    Boolean             @default(true) @map("is_active")
  createdBy   String?             @map("created_by")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @default(now()) @map("updated_at")
  creator     User?               @relation(fields: [createdBy], references: [id])
  documents   KnowledgeDocument[]
  scenarios   ScenarioCategory[]

  @@map("business_categories")
}

model ScenarioCategory {
  id                 String              @id @default(uuid())
  businessCategoryId String              @map("business_category_id")
  name               String
  description        String?
  sortOrder          Int                 @default(0) @map("sort_order")
  isActive           Boolean             @default(true) @map("is_active")
  createdBy          String?             @map("created_by")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @default(now()) @map("updated_at")
  documents          KnowledgeDocument[]
  businessCategory   BusinessCategory    @relation(fields: [businessCategoryId], references: [id])
  creator            User?               @relation(fields: [createdBy], references: [id])

  @@map("scenario_categories")
}

model KnowledgeDocument {
  id                 String               @id @default(uuid())
  title              String
  content            String?
  summary            String?
  businessCategoryId String?              @map("business_category_id")
  scenarioCategoryId String?              @map("scenario_category_id")
  sourceType         String               @default("manual") @map("source_type")
  sourceUrl          String?              @map("source_url")
  externalId         String?              @map("external_id")
  fileName           String?              @map("file_name")
  filePath           String?              @map("file_path")
  fileSize           BigInt?              @map("file_size")
  fileType           String?              @map("file_type")
  mimeType           String?              @map("mime_type")
  status             String               @default("draft")
  version            Int                  @default(1)
  isVectorized       Boolean              @default(false) @map("is_vectorized")
  readCount          Int                  @default(0) @map("read_count")
  referenceCount     Int                  @default(0) @map("reference_count")
  tags               String[]
  createdBy          String?              @map("created_by")
  updatedBy          String?              @map("updated_by")
  publishedAt        DateTime?            @map("published_at")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @default(now()) @map("updated_at")
  mostReferenced     DashboardSnapshot[]  @relation("MostReferencedDocument")
  mostViewed         DashboardSnapshot[]  @relation("MostViewedDocument")
  attachments        DocumentAttachment[]
  chunks             DocumentChunk[]
  versions           DocumentVersion[]
  businessCategory   BusinessCategory?    @relation(fields: [businessCategoryId], references: [id])
  creator            User?                @relation("CreatedBy", fields: [createdBy], references: [id])
  scenarioCategory   ScenarioCategory?    @relation(fields: [scenarioCategoryId], references: [id])
  updater            User?                @relation("UpdatedBy", fields: [updatedBy], references: [id])
  heatmaps           KnowledgeHeatmap[]

  @@map("knowledge_documents")
}

model DocumentVersion {
  id                String            @id @default(uuid())
  documentId        String            @map("document_id")
  version           Int
  title             String
  content           String
  changeDescription String?           @map("change_description")
  createdBy         String?           @map("created_by")
  createdAt         DateTime          @default(now()) @map("created_at")
  creator           User?             @relation(fields: [createdBy], references: [id])
  document          KnowledgeDocument @relation(fields: [documentId], references: [id])

  @@unique([documentId, version])
  @@map("document_versions")
}

model DocumentAttachment {
  id          String            @id @default(uuid())
  documentId  String            @map("document_id")
  fileName    String            @map("file_name")
  filePath    String            @map("file_path")
  fileSize    BigInt?           @map("file_size")
  mimeType    String            @map("mime_type")
  fileType    String            @map("file_type")
  description String?
  sortOrder   Int               @default(0) @map("sort_order")
  createdAt   DateTime          @default(now()) @map("created_at")
  document    KnowledgeDocument @relation(fields: [documentId], references: [id])

  @@map("document_attachments")
}

model DocumentChunk {
  id            String                 @id @default(uuid())
  documentId    String                 @map("document_id")
  chunkIndex    Int                    @map("chunk_index")
  content       String
  contentLength Int                    @map("content_length")
  tokenCount    Int?
  pageNumber    Int?                   @map("page_number")
  chunkType     String                 @default("text") @map("chunk_type")
  isProcessed   Boolean                @default(false) @map("is_processed")
  processedAt   DateTime?              @map("processed_at")
  createdAt     DateTime               @default(now()) @map("created_at")
  embedding     Unsupported("vector")?
  document      KnowledgeDocument      @relation(fields: [documentId], references: [id])
  heatmaps      KnowledgeHeatmap[]

  @@unique([documentId, chunkIndex])
  @@map("document_chunks")
}

model ChatSession {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  title         String?
  messageCount  Int           @default(0) @map("message_count")
  lastMessageAt DateTime?     @map("last_message_at")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @default(now()) @map("updated_at")
  messages      ChatMessage[]
  user          User          @relation(fields: [userId], references: [id])

  @@map("chat_sessions")
}

model ChatMessage {
  id                 String            @id @default(uuid())
  sessionId          String            @map("session_id")
  role               String
  content            String
  userMessageType    String?           @default("text") @map("user_message_type")
  audioFilePath      String?           @map("audio_file_path")
  imageFilePath      String?           @map("image_file_path")
  aiResponseMetadata Json?
  tokenUsage         Int?              @map("token_usage")
  responseTime       Int?              @map("response_time")
  referencedChunks   String[]          @map("referenced_chunks")
  confidenceScore    Float?            @map("confidence_score")
  createdAt          DateTime          @default(now()) @map("created_at")
  session            ChatSession       @relation(fields: [sessionId], references: [id])
  feedbacks          MessageFeedback[]

  @@map("chat_messages")
}

model MessageFeedback {
  id           String      @id @default(uuid())
  messageId    String      @map("message_id")
  rating       Int?
  feedbackText String?
  createdAt    DateTime    @default(now()) @map("created_at")
  message      ChatMessage @relation(fields: [messageId], references: [id])

  @@map("message_feedbacks")
}

model UnansweredQuestion {
  id                String    @id @default(uuid())
  questionText      String    @map("question_text")
  questionEmbedding Bytes?    @map("question_embedding")
  askCount          Int       @default(1) @map("ask_count")
  firstAskedAt      DateTime  @default(now()) @map("first_asked_at")
  lastAskedAt       DateTime  @default(now()) @map("last_asked_at")
  isResolved        Boolean   @default(false) @map("is_resolved")
  resolvedAt        DateTime? @map("resolved_at")
  resolvedBy        String?   @map("resolved_by")
  resolver          User?     @relation(fields: [resolvedBy], references: [id])

  @@map("unanswered_questions")
}

model KnowledgeHeatmap {
  id             String            @id @default(uuid())
  documentId     String            @map("document_id")
  chunkId        String?           @map("chunk_id")
  date           DateTime          @map("date")
  viewCount      Int               @default(0) @map("view_count")
  referenceCount Int               @default(0) @map("reference_count")
  uniqueUsers    Int               @default(0) @map("unique_users")
  createdAt      DateTime          @default(now()) @map("created_at")
  chunk          DocumentChunk?    @relation(fields: [chunkId], references: [id])
  document       KnowledgeDocument @relation(fields: [documentId], references: [id])

  @@unique([documentId, chunkId, date])
  @@map("knowledge_heatmap")
}

model FrequentQuestion {
  id                String    @id @default(uuid())
  questionPattern   String    @map("question_pattern")
  questionEmbedding Bytes?    @map("question_embedding")
  askCount          Int       @default(0) @map("ask_count")
  uniqueUsers       Int       @default(0) @map("unique_users")
  firstAskedAt      DateTime? @map("first_asked_at")
  lastAskedAt       DateTime? @map("last_asked_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@map("frequent_questions")
}

model DashboardSnapshot {
  id                       String             @id @default(uuid())
  snapshotDate             DateTime           @map("snapshot_date")
  totalDocuments           Int                @default(0) @map("total_documents")
  totalSessions            Int                @default(0) @map("total_sessions")
  totalMessages            Int                @default(0) @map("total_messages")
  avgResponseTime          Float              @default(0) @map("avg_response_time")
  userSatisfactionRate     Float              @default(0) @map("user_satisfaction_rate")
  mostViewedDocumentId     String?            @map("most_viewed_document_id")
  mostReferencedDocumentId String?            @map("most_referenced_document_id")
  createdAt                DateTime           @default(now()) @map("created_at")
  mostReferencedDocument   KnowledgeDocument? @relation("MostReferencedDocument", fields: [mostReferencedDocumentId], references: [id])
  mostViewedDocument       KnowledgeDocument? @relation("MostViewedDocument", fields: [mostViewedDocumentId], references: [id])

  @@map("dashboard_snapshots")
}

model DataSourceSync {
  id             String    @id @default(uuid())
  sourceType     String    @map("source_type")
  syncType       String?   @map("sync_type")
  status         String    @default("pending")
  itemsProcessed Int       @default(0) @map("items_processed")
  itemsTotal     Int       @default(0) @map("items_total")
  errorMessage   String?   @map("error_message")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@map("data_source_syncs")
}

model JobQueue {
  id           String    @id @default(uuid())
  queueName    String    @map("queue_name")
  jobName      String    @map("job_name")
  payload      Json?
  status       String    @default("waiting")
  attempts     Int       @default(0)
  errorMessage String?   @map("error_message")
  runAt        DateTime? @map("run_at")
  startedAt    DateTime? @map("started_at")
  finishedAt   DateTime? @map("finished_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("job_queues")
}
